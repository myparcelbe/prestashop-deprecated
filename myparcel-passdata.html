<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
    <title>MyParcel - Prestashop - Passdata from PostNL through MyParcel</title>
</head>
<body>
<script type="text/javascript">
/* Querystring.js ******************************************************************************/
    function Querystring(qs) { // optionally pass a querystring to parse
        this.params = new Object()
        this.get=Querystring_get

        if (qs == null)
            qs=location.search.substring(1,location.search.length)

        if (qs.length == 0) return

        qs = qs.replace(/\+/g, ' ')
        var args = qs.split('&') // parse out name/value pairs separated via &


        for (var i=0;i<args.length;i++) {
            var value;
            var pair = args[i].split('=')
            var name = unescape(pair[0])

            if (pair.length == 2)
                value = unescape(pair[1])
            else
                value = name

            this.params[name] = value
        }
    }

    function Querystring_get(key, default_) {
        // This silly looking line changes UNDEFINED to NULL
        if (default_ == null) default_ = null;

        var value=this.params[key]
        if (value==null) value=default_;

        return value
    }

    window.onload = passData;
    function passData()
    {
        var name;
        var street;
        var houseNr;
        var houseNrAdd;
        var postalCodeNum;
        var postalCodeAlpha;
        var city;

        var qs = new Querystring();
        if (qs.get("action") == "confirm")
        {
            name            = qs.get('name');
            street          = qs.get('street');
            houseNr         = qs.get('housenumber');
            houseNrAdd      = qs.get('housenumberadd');
            postalCodeNum   = qs.get('postalcodenum');
            postalCodeAlpha = qs.get('postalcodealpha');
            city            = qs.get('city');

            if(parent.parent.window.opener)
            {
                var shopname = name.split('&nbsp;&nbsp;');
                if(shopname.length == 2) shopname = shopname[1];

                // NOTE: hieronder specificeert u de naam van het formulier
                // in dit voorbeeld: 'checkout_shipping'
                var formulier = parent.parent.window.opener.document;//.forms['userForm'];
                //console.log(formulier);
                // NOTE: hieronder stopt u de variabelen in uw formulier
                // in dit voorbeeld: 'company', 'postcode', 'street_address', 'house_number' en 'city'
                try {
                    formulier.getElementsByName("company")[0].value   = shopname;
                } catch (err) {}

                try {
                    formulier.getElementsByName("postcode")[0].value       = postalCodeNum + postalCodeAlpha;
                } catch (err) {}

                try {
                    formulier.getElementsByName("address1")[0].value = street + ' ' + houseNr + ' ' + houseNrAdd;
                } catch (err) {}

                try {
                    formulier.getElementsByName("city")[0].value = city;
                } catch (err) {}

                // NOTE: de locatie slaan we op als 'bedrijf'. De naam van de persoon die afhaalt, dient door de klant ingevuld te worden in een 'naam' veld.

                // NOTE: zorg dat pakjegemak zendingen naar Nederland gaan
                // in dit voorbeeld vullen we de 'country' drop-down automatisch goed in
                try {
                    formulier.getElementsByName("id_country")[0].value = 13;
                } catch (err) {}

                try{
                    fireEvent(formulier.getElementsByName("id_country")[0], 'change');
                }catch(ex){
                    // Possbile IE 11
                    var add_address_button = formulier.getElementById('add_address');
					if (add_address_button) {
						add_address_button.submit();
					}
                }
				
				// *************************Fixes for OnePageCheckout plugin*************************
                // *******************This fix for alarm-winkel.nl and mytools.nl********************
                // **********************************************************************************
                if (formulier.getElementById("form_onepagecheckoutps")) {
                    try {
                        formulier.getElementById("delivery_company").value   = shopname;
                    } catch (err) {}

                    try {
                        formulier.getElementById("delivery_postcode").value       = postalCodeNum + postalCodeAlpha;
                    } catch (err) {}

                    try {
                        formulier.getElementById("delivery_address1").value = street + ' ' + houseNr + ' ' + houseNrAdd;
                    } catch (err) {}

                    try {
                        formulier.getElementById("delivery_city").value = city;
                    } catch (err) {}

                    try {
                        var country_select =  formulier.getElementById("delivery_id_country");
                        country_select.value = 13;

                        for (var i = 0; i < country_select.options.length; i++) {
                            if (country_select.options[i].text === ' Nederland') {
                                country_select.selectedIndex = i;
                                fireEvent(formulier.getElementById("delivery_id_country"), 'change');
                                break;
                            }
                        }
                    } catch (err) {}

                    try{
                        fireEvent(formulier.getElementById("delivery_id_country"), 'change');
                        formulier.getElementById('shipping_container').getElementsByTagName('button')[0].click();
                    }catch(ex){
                        // Possbile IE 11
                        //formulier.getElementById('add_address').submit();
                    }
                }


                // **********************************************************************************
                // ************************ Set data for pg extra fields ****************************
                // **********************************************************************************
            }
        }
        parent.parent.window.close();
    }

    function fireEvent(element,event){
        if (document.createEventObject){
            // dispatch for IE
            var evt = document.createEventObject();
            return element.fireEvent('on'+event,evt)
        }
        else{
            // dispatch for firefox + others
            var evt = new Event(event);
            return !element.dispatchEvent(evt);
        }
    }
</script>
</body>
</html>